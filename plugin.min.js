/*
* TinyMCE 4+ Image Caption for captioneering images
* @author: Barrack Angujo
* @date : November 25, 2014
* @email : angujomondi@gmail.com
* @web : http://manetechnologies.com
* @tweet : @angujomondi
*/

/*
* You are free to use this file by performing modification where neccessary.
* Don't forget to give credit where it is due.
* If you tweet about it on my handle, THANKS BIG TIME!
*/

tinymce.PluginManager.add('caption', function (editor, url) {
    // Add a button that opens a window
    editor.addButton('caption', {
        text: 'Enter Caption',
        icon: false,
        onclick: function () {
            // Open window
            open_caption_window();
        }
    });

    // Adds a menu item to the tools menu
    editor.addMenuItem('caption', {
        text: 'Image Caption',
        context: 'insert',
        onclick: function () {
            open_caption_window();
        }
    });

    function open_caption_window() {
        var selection = image_content(editor.selection.getContent());
        if(!selection){
            alert('No Image Found on your selection!');
            return false; 
            }

        editor.windowManager.open({
            width: 400,
            height: 150,
            title: 'Image Caption',
            body: [
                {type: 'textbox', name: 'the_caption', label: 'Title'}
            ],
            onsubmit: function (e) {
                // Insert content when the window form is submitted
                if(selection=image_content(selection)){
                    editor.insertContent(captionized(e.data.the_caption, selection));
                }
            }
        });
    }

    function image_content(all_contents) {
        var str = all_contents;
        var indexA = str.indexOf('<img'), indexB = str.indexOf('>', indexA);
        if (-1 == indexA) return false;
        return str.substring(indexA, indexB + 1);
    }

    function captionized(txt, img) {
        return ['<span style="display: inline-block;">',
            '<span style="display: block;">',
            img,
            '</span>',
            '<span style="font-weight: bold;font-style: italic !important;display: inline-block;">', txt, '</span>',
            '</span>'].join('');
    }
});

/** End of file**/
